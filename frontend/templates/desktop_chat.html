{% extends "base.html" %}

{% block title %}Chat - IntelliSearch{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/desktop.css') }}">
{% endblock %}

{% block body_class %}desktop-chat{% endblock %}

{% block content %}
<div class="chat-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <div class="logo-icon">IS</div>
                <span class="logo-text">IntelliSearch</span>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <a href="{{ url_for('new_chat') }}" class="nav-item nav-item-new">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                New Chat
            </a>
            
            <div class="nav-section">
                <div class="nav-section-title">Navigation</div>
                <a href="{{ url_for('desktop_chat') }}" class="nav-item active">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    Chat
                </a>
                <a href="{{ url_for('mobile_chat') }}" class="nav-item">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
                        <line x1="12" y1="18" x2="12.01" y2="18"/>
                    </svg>
                    Mobile View
                </a>
                {% if session.get('is_admin') %}
                <a href="{{ url_for('admin_dashboard') }}" class="nav-item">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    </svg>
                    Admin Panel
                </a>
                {% endif %}
            </div>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="avatar" style="background: {{ user['avatar_color'] or '#6366f1' }}">
                    {{ (user['display_name'] or user['username'])[0] }}
                </div>
                <div class="user-details">
                    <span class="user-name">{{ user['display_name'] or user['username'] }}</span>
                    <span class="user-tokens">{{ "{:,}".format(user['total_tokens'] or 0) }} tokens</span>
                </div>
            </div>
            <a href="{{ url_for('logout') }}" class="btn btn-ghost btn-icon" title="Logout">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
            </a>
        </div>
    </aside>
    
    <!-- Main Chat Area -->
    <main class="chat-main">
        <header class="chat-header">
            <div class="chat-header-info">
                <h1>Chat Session</h1>
                <span class="session-id text-muted text-sm">{{ session.get('chat_session_id', '')[:8] }}...</span>
            </div>
            <div class="chat-header-actions">
                <label class="tool-toggle">
                    <input type="checkbox" id="use-tools" checked>
                    <span class="toggle-label">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                        </svg>
                        Tools
                    </span>
                </label>
            </div>
        </header>
        
        <div class="chat-messages" id="chat-messages">
            <div class="welcome-message">
                <div class="welcome-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                        <line x1="9" y1="9" x2="9.01" y2="9"/>
                        <line x1="15" y1="9" x2="15.01" y2="9"/>
                    </svg>
                </div>
                <h2>How can I help you today?</h2>
                <p class="text-muted">Ask me anything. I can search the web, run code, and much more.</p>
                
                <div class="quick-prompts">
                    <button class="quick-prompt" onclick="sendQuickPrompt('Explain quantum computing in simple terms')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="16" x2="12" y2="12"/>
                            <line x1="12" y1="8" x2="12.01" y2="8"/>
                        </svg>
                        Explain quantum computing
                    </button>
                    <button class="quick-prompt" onclick="sendQuickPrompt('Write a Python function to calculate Fibonacci numbers')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="16 18 22 12 16 6"/>
                            <polyline points="8 6 2 12 8 18"/>
                        </svg>
                        Write Fibonacci code
                    </button>
                    <button class="quick-prompt" onclick="sendQuickPrompt('What are the latest news in AI?')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                        </svg>
                        Latest AI news
                    </button>
                </div>
            </div>
        </div>
        
        <div class="chat-input-area">
            <form id="chat-form" class="chat-form">
                <div class="input-wrapper">
                    <textarea 
                        id="message-input" 
                        placeholder="Type your message... (Shift+Enter for new line)"
                        rows="1"
                        autofocus
                    ></textarea>
                    <button type="submit" class="send-btn" id="send-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"/>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                        </svg>
                    </button>
                </div>
            </form>
            <p class="input-hint text-xs text-muted text-center mt-sm">
                IntelliSearch can make mistakes. Consider checking important information.
            </p>
        </div>
    </main>
</div>

<!-- Process Indicator -->
<div class="process-indicator" id="process-indicator">
    <div class="process-content">
        <div class="spinner"></div>
        <span class="process-text">Thinking...</span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const processIndicator = document.getElementById('process-indicator');
    const useToolsCheckbox = document.getElementById('use-tools');
    
    let isStreaming = false;
    
    // Auto-resize textarea
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 200) + 'px';
    });
    
    // Handle Enter key
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!isStreaming && this.value.trim()) {
                chatForm.dispatchEvent(new Event('submit'));
            }
        }
    });
    
    // Send quick prompt
    function sendQuickPrompt(text) {
        messageInput.value = text;
        chatForm.dispatchEvent(new Event('submit'));
    }
    
    // Create message element
    function createMessage(role, content) {
        const welcomeMsg = chatMessages.querySelector('.welcome-message');
        if (welcomeMsg) welcomeMsg.remove();
        
        const msgDiv = document.createElement('div');
        msgDiv.className = `message message-${role}`;
        
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        
        if (role === 'user') {
            avatar.style.background = '{{ user["avatar_color"] or "#6366f1" }}';
            avatar.textContent = '{{ (user["display_name"] or user["username"])[0] }}';
        } else {
            avatar.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>';
        }
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content markdown-content';
        
        if (role === 'user') {
            contentDiv.textContent = content;
        } else {
            contentDiv.innerHTML = renderMarkdown(content);
            renderLatex(contentDiv);
        }
        
        msgDiv.appendChild(avatar);
        msgDiv.appendChild(contentDiv);
        chatMessages.appendChild(msgDiv);
        
        return contentDiv;
    }
    
    // Create tool call indicator
    function createToolIndicator(toolName) {
        const indicator = document.createElement('div');
        indicator.className = 'tool-indicator';
        indicator.innerHTML = `
            <div class="tool-icon">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                </svg>
            </div>
            <span>Using tool: <strong>${toolName}</strong></span>
            <div class="spinner" style="width: 14px; height: 14px;"></div>
        `;
        chatMessages.appendChild(indicator);
        return indicator;
    }
    
    // Handle form submission
    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        if (!message || isStreaming) return;
        
        isStreaming = true;
        sendBtn.disabled = true;
        messageInput.value = '';
        messageInput.style.height = 'auto';
        
        // Add user message
        createMessage('user', message);
        scrollToBottom();
        
        // Show process indicator
        processIndicator.classList.add('visible');
        processIndicator.querySelector('.process-text').textContent = 'Thinking...';
        
        // Create assistant message placeholder
        const assistantContent = createMessage('assistant', '');
        let fullContent = '';
        let currentToolIndicator = null;
        
        try {
            const response = await fetch('/api/chat/stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    use_tools: useToolsCheckbox.checked
                })
            });
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.slice(6);
                        
                        if (data === '[DONE]') {
                            processIndicator.classList.remove('visible');
                            continue;
                        }
                        
                        try {
                            const event = JSON.parse(data);
                            
                            if (event.type === 'content') {
                                if (currentToolIndicator) {
                                    currentToolIndicator.classList.add('completed');
                                    currentToolIndicator = null;
                                }
                                fullContent += event.content;
                                assistantContent.innerHTML = renderMarkdown(fullContent);
                                renderLatex(assistantContent);
                                scrollToBottom();
                            } else if (event.type === 'tool_call_start') {
                                processIndicator.querySelector('.process-text').textContent = 
                                    `Using ${event.tool_call.name}...`;
                                currentToolIndicator = createToolIndicator(event.tool_call.name);
                                scrollToBottom();
                            } else if (event.type === 'tool_result') {
                                if (currentToolIndicator) {
                                    currentToolIndicator.classList.add('completed');
                                    currentToolIndicator.querySelector('.spinner').remove();
                                }
                                processIndicator.querySelector('.process-text').textContent = 'Processing results...';
                            } else if (event.type === 'error') {
                                assistantContent.innerHTML = `<div class="error-message">${event.error}</div>`;
                            }
                        } catch (err) {
                            console.error('Parse error:', err);
                        }
                    }
                }
            }
        } catch (error) {
            console.error('Stream error:', error);
            assistantContent.innerHTML = `<div class="error-message">Connection error. Please try again.</div>`;
        } finally {
            isStreaming = false;
            sendBtn.disabled = false;
            processIndicator.classList.remove('visible');
            messageInput.focus();
        }
    });
    
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
</script>
{% endblock %}

