{% extends "base.html" %}

{% block title %}Chat - IntelliSearch{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/mobile.css') }}">
<meta name="theme-color" content="#0a0a0f">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
{% endblock %}

{% block body_class %}mobile-chat{% endblock %}

{% block content %}
<div class="mobile-layout">
    <!-- Header -->
    <header class="mobile-header">
        <button class="menu-btn" id="menu-btn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="12" x2="21" y2="12"/>
                <line x1="3" y1="6" x2="21" y2="6"/>
                <line x1="3" y1="18" x2="21" y2="18"/>
            </svg>
        </button>
        
        <div class="header-title">
            <div class="logo-icon-sm">IS</div>
            <span>IntelliSearch</span>
        </div>
        
        <a href="{{ url_for('mobile_new_chat') }}" class="new-chat-btn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
        </a>
    </header>
    
    <!-- Slide-out Menu -->
    <div class="mobile-menu-overlay" id="menu-overlay"></div>
    <nav class="mobile-menu" id="mobile-menu">
        <div class="menu-header">
            <div class="user-info">
                <div class="avatar" style="background: {{ user['avatar_color'] or '#6366f1' }}">
                    {{ (user['display_name'] or user['username'])[0] }}
                </div>
                <div class="user-details">
                    <span class="user-name">{{ user['display_name'] or user['username'] }}</span>
                    <span class="user-tokens">{{ "{:,}".format(user['total_tokens'] or 0) }} tokens used</span>
                </div>
            </div>
        </div>
        
        <div class="menu-nav">
            <a href="{{ url_for('mobile_chat') }}" class="menu-item active">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Chat
            </a>
            <a href="{{ url_for('desktop_chat') }}" class="menu-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                    <line x1="8" y1="21" x2="16" y2="21"/>
                    <line x1="12" y1="17" x2="12" y2="21"/>
                </svg>
                Desktop View
            </a>
            {% if session.get('is_admin') %}
            <a href="{{ url_for('admin_dashboard') }}" class="menu-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
                Admin Panel
            </a>
            {% endif %}
        </div>
        
        <div class="menu-footer">
            <a href="{{ url_for('logout') }}" class="menu-item menu-item-danger">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                Sign Out
            </a>
        </div>
    </nav>
    
    <!-- Chat Area -->
    <main class="mobile-chat-area" id="chat-messages">
        <div class="welcome-message">
            <div class="welcome-icon">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                    <line x1="9" y1="9" x2="9.01" y2="9"/>
                    <line x1="15" y1="9" x2="15.01" y2="9"/>
                </svg>
            </div>
            <h2>Hello!</h2>
            <p>How can I help you today?</p>
            
            <div class="quick-prompts">
                <button class="quick-prompt" onclick="sendQuickPrompt('What is machine learning?')">
                    What is ML?
                </button>
                <button class="quick-prompt" onclick="sendQuickPrompt('Write a Python hello world')">
                    Python code
                </button>
                <button class="quick-prompt" onclick="sendQuickPrompt('Explain E=mcÂ²')">
                    Physics help
                </button>
            </div>
        </div>
    </main>
    
    <!-- Process Indicator -->
    <div class="process-bar" id="process-bar">
        <div class="process-bar-content">
            <div class="loading-dots">
                <span></span><span></span><span></span>
            </div>
            <span class="process-text">Thinking...</span>
        </div>
    </div>
    
    <!-- Input Area -->
    <div class="mobile-input-area">
        <div class="tool-toggle-mobile">
            <label class="toggle-pill">
                <input type="checkbox" id="use-tools" checked>
                <span class="toggle-pill-text">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                    </svg>
                    Tools
                </span>
            </label>
        </div>
        
        <form id="chat-form" class="mobile-chat-form">
            <div class="input-row">
                <textarea 
                    id="message-input" 
                    placeholder="Message..."
                    rows="1"
                ></textarea>
                <button type="submit" class="send-btn" id="send-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"/>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                    </svg>
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const processBar = document.getElementById('process-bar');
    const useToolsCheckbox = document.getElementById('use-tools');
    const menuBtn = document.getElementById('menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    const menuOverlay = document.getElementById('menu-overlay');
    
    let isStreaming = false;
    
    // Menu toggle
    menuBtn.addEventListener('click', () => {
        mobileMenu.classList.add('open');
        menuOverlay.classList.add('visible');
    });
    
    menuOverlay.addEventListener('click', () => {
        mobileMenu.classList.remove('open');
        menuOverlay.classList.remove('visible');
    });
    
    // Auto-resize textarea
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    // Handle Enter key
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!isStreaming && this.value.trim()) {
                chatForm.dispatchEvent(new Event('submit'));
            }
        }
    });
    
    // Send quick prompt
    function sendQuickPrompt(text) {
        messageInput.value = text;
        chatForm.dispatchEvent(new Event('submit'));
    }
    
    // Create message element
    function createMessage(role, content) {
        const welcomeMsg = chatMessages.querySelector('.welcome-message');
        if (welcomeMsg) welcomeMsg.remove();
        
        const msgDiv = document.createElement('div');
        msgDiv.className = `message message-${role}`;
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        if (role === 'user') {
            contentDiv.textContent = content;
        } else {
            contentDiv.className += ' markdown-content';
            contentDiv.innerHTML = renderMarkdown(content);
            renderLatex(contentDiv);
        }
        
        if (role === 'assistant') {
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar-mobile';
            avatar.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>';
            msgDiv.appendChild(avatar);
        }
        
        msgDiv.appendChild(contentDiv);
        chatMessages.appendChild(msgDiv);
        
        return contentDiv;
    }
    
    // Create tool indicator
    function createToolIndicator(toolName) {
        const indicator = document.createElement('div');
        indicator.className = 'tool-indicator-mobile';
        indicator.innerHTML = `
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
            </svg>
            <span>${toolName}</span>
        `;
        chatMessages.appendChild(indicator);
        return indicator;
    }
    
    // Handle form submission
    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        if (!message || isStreaming) return;
        
        isStreaming = true;
        sendBtn.disabled = true;
        messageInput.value = '';
        messageInput.style.height = 'auto';
        
        // Add user message
        createMessage('user', message);
        scrollToBottom();
        
        // Show process bar
        processBar.classList.add('visible');
        processBar.querySelector('.process-text').textContent = 'Thinking...';
        
        // Create assistant message placeholder
        const assistantContent = createMessage('assistant', '');
        let fullContent = '';
        
        try {
            const response = await fetch('/api/chat/stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    use_tools: useToolsCheckbox.checked
                })
            });
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.slice(6);
                        
                        if (data === '[DONE]') {
                            processBar.classList.remove('visible');
                            continue;
                        }
                        
                        try {
                            const event = JSON.parse(data);
                            
                            if (event.type === 'content') {
                                fullContent += event.content;
                                assistantContent.innerHTML = renderMarkdown(fullContent);
                                renderLatex(assistantContent);
                                scrollToBottom();
                            } else if (event.type === 'tool_call_start') {
                                processBar.querySelector('.process-text').textContent = event.tool_call.name;
                                createToolIndicator(event.tool_call.name);
                                scrollToBottom();
                            } else if (event.type === 'error') {
                                assistantContent.innerHTML = `<div class="error-message">${event.error}</div>`;
                            }
                        } catch (err) {}
                    }
                }
            }
        } catch (error) {
            assistantContent.innerHTML = '<div class="error-message">Connection error</div>';
        } finally {
            isStreaming = false;
            sendBtn.disabled = false;
            processBar.classList.remove('visible');
        }
    });
    
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
</script>
{% endblock %}

